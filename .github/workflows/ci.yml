name: CI

on:
  push:
    branches:
      - main

  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.4
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Setup system
        uses: ./.github/actions/setup-system
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix-key: tests
      - name: Run tests
        env:
          RUSTC_WRAPPER: sccache
        run: just test
      - name: sccache stats
        run: sccache --show-stats

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.6
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: lint-${{ runner.os }}
      - name: Setup system
        uses: ./.github/actions/setup-system
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix-key: lint
      - name: Run lint checks
        env:
          RUSTC_WRAPPER: sccache
        run: |
          just fmt
          just clippy
      - name: Install and run cargo-machete
        uses: clechasseur/rs-cargo@v2
        with:
          command: machete
          install: cargo-machete@0.7.0
      - name: Cargo audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ignore: "RUSTSEC-2023-0071,RUSTSEC-2025-0009,RUSTSEC-2022-0093,RUSTSEC-2024-0344"
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats

  solana-contract:
    name: Build & Test Solana Contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.6
      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: solana-${{ runner.os }}
      - name: Setup just
        uses: extractions/setup-just@v2
      - name: Setup system
        uses: ./.github/actions/setup-system
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix-key: solana
      - name: Install Solana tools
        run: |
          curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash
          sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
          echo "/home/runner/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Test Solana contract
        working-directory: solana
        env:
          RUSTC_WRAPPER: sccache
        run: just test
      - name: Show sccache stats
        if: always()
        run: sccache --show-stats
