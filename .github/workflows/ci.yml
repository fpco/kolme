name: CI

on:
  push:
    branches:
      - main

  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  contract-init-poc:
    name: Contract Init Bug (PoC)
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup system
        uses: ./.github/actions/setup-system
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache-prefix-key: tests
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: kiik7r
          password: ${{ secrets.BUG_SOLANA_GITHUB_TOKEN }}
      - name: Install solana-cli
        run: |
          curl --proto '=https' --tlsv1.2 -sSfL https://solana-install.solana.workers.dev | bash
          sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
          export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
          solana --version
      - name: Restore solana wallet
        run: |
          echo "${{secrets.BUG_SOLANA_WALLET_JSON}}" | base64 -d > ~/.config/solana/id.json
          chmod 600 ~/.config/solana/id.json
      - name: Build bridge contract
        working-directory: solana
        run: |
          export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
          cargo build-sbf
      - name: Upload contract
        working-directory: solana
        run: |
          export PATH="/home/runner/.local/share/solana/install/active_release/bin:$PATH"
          solana address
          solana program deploy target/deploy/kolme_solana_bridge.so --url https://api.devnet.solana.com > output.txt
          SOLANA_PROGRAM_ID=$(grep "Program Id:" output.txt | awk '{print $3}')
          echo "SOLANA_PROGRAM_ID=$SOLANA_PROGRAM_ID" >> $GITHUB_ENV
      - name: Start kolme-app with uploaded contract
        working-directory: solana
        run: |
          echo "Waiting 30s for the contract to be uploaded"
          sleep 30
          mkdir -p env
          touch env/kolme-app.env.values
          echo "$SOLANA_PROGRAM_ID"
          echo "BRIDGE_ADDR=$SOLANA_PROGRAM_ID" > env/kolme-app.env.values
          echo "${{secrets.BUG_SOLANA_ENV_FILE}}" | base64 -d >> env/kolme-app.env.values
          docker compose up
